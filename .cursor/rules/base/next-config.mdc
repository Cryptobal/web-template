---
description: 
globs: 
alwaysApply: true
---
# Regla: next-config.mdc

## üéØ Prop√≥sito
Establecer una configuraci√≥n √≥ptima y estandarizada para Next.js, habilitando todas las caracter√≠sticas avanzadas necesarias para un proyecto profesional, incluyendo soporte para m√∫ltiples entornos, optimizaciones de rendimiento y compatibilidad con herramientas externas.

---

## ‚öôÔ∏è Configuraci√≥n Base

```javascript
// next.config.js
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  images: {
    domains: ['cdn.tusitio.com', 'images.unsplash.com', 'res.cloudinary.com'],
    formats: ['image/avif', 'image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },
  i18n: {
    locales: ['es', 'en'],
    defaultLocale: 'es',
    localeDetection: true,
  },
  experimental: {
    appDir: true,
    serverComponentsExternalPackages: [],
    instrumentationHook: true,
  },
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
    styledComponents: false,
  },
  poweredByHeader: false,
  modularizeImports: {
    '@mui/icons-material': {
      transform: '@mui/icons-material/{{member}}',
    },
    '@mui/material': {
      transform: '@mui/material/{{member}}',
    },
    'lodash': {
      transform: 'lodash/{{member}}',
    },
  },
};

// Headers de seguridad y cach√©
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on',
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block',
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin',
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()',
  },
];

// Configuraci√≥n de redirecciones
const redirects = async () => {
  return [
    {
      source: '/old-blog/:slug',
      destination: '/blog/:slug',
      permanent: true,
    },
    // Otras redirecciones espec√≠ficas del proyecto
  ];
};

// Configuraci√≥n de headers
const headers = async () => {
  return [
    {
      source: '/:path*',
      headers: securityHeaders,
    },
    {
      source: '/fonts/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=31536000, immutable',
        },
      ],
    },
    {
      source: '/images/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=86400, stale-while-revalidate=31536000',
        },
      ],
    },
  ];
};

// Configuraci√≥n final completa
module.exports = {
  ...nextConfig,
  async redirects() {
    return redirects();
  },
  async headers() {
    return headers();
  },
};
```

---

## üîÑ Integraciones con plugins

### 1. Bundle Analyzer (opcional)
```javascript
// M√≥dulo para analizar tama√±o del bundle
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

module.exports = withBundleAnalyzer({
  // Resto de la configuraci√≥n
});
```

### 2. Soporte para SVG como componentes
```javascript
// M√≥dulo para usar SVG como componentes
const withSvgr = require('next-svgr');

module.exports = withSvgr({
  svgrOptions: {
    svgoConfig: {
      plugins: [
        {
          name: 'preset-default',
          params: {
            overrides: {
              removeViewBox: false,
            },
          },
        },
      ],
    },
  },
  // Resto de la configuraci√≥n
});
```

---

## üîß Configuraci√≥n por entornos

```javascript
// utils/env-config.js
const getEnvironmentConfig = () => {
  switch (process.env.APP_ENV) {
    case 'development':
      return {
        // Configuraci√≥n para desarrollo
        enableMocks: true,
        debugMode: true,
      };
    case 'staging':
      return {
        // Configuraci√≥n para staging
        enableMocks: false,
        debugMode: true,
      };
    case 'production':
    default:
      return {
        // Configuraci√≥n para producci√≥n
        enableMocks: false,
        debugMode: false,
      };
  }
};

module.exports = getEnvironmentConfig();
```

---

## üõ†Ô∏è Scripts NPM estandarizados

```json
// package.json (secci√≥n scripts)
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "analyze": "ANALYZE=true next build",
    "postbuild": "next-sitemap",
    "type-check": "tsc --noEmit",
    "test": "jest",
    "test:watch": "jest --watch",
    "cypress": "cypress open",
    "cypress:headless": "cypress run",
    "prepare": "husky install",
    "format": "prettier --write \"**/*.{js,jsx,ts,tsx,json,css,scss,md}\"",
    "storybook": "storybook dev -p 6006",
    "build-storybook": "storybook build"
  }
}
```

---

## üõ†Ô∏è Reglas para Cursor (Frontend)

- Utilizar la configuraci√≥n exacta de `next.config.js` como base para todos los proyectos
- Personalizar dominios de im√°genes seg√∫n CDN elegido para el proyecto
- Habilitar i18n solo si el proyecto lo requiere, manteniendo la estructura base
- Personalizar redirecciones espec√≠ficas para cada proyecto
- La secci√≥n experimental debe adaptarse a la versi√≥n actual de Next.js
- Mantener todos los headers de seguridad y cache por defecto
- Los plugins opcionales (bundle analyzer, SVGR) deben activarse seg√∫n necesidades 

---

## üå©Ô∏è Optimizaci√≥n para Vercel y Cloudflare

### Configuraci√≥n espec√≠fica para Vercel

```javascript
// next.config.js con optimizaciones para Vercel
const nextConfig = {
  // Configuraci√≥n base mantenida...
  
  // Optimizaciones para Vercel Edge Network
  output: 'standalone', // Mejor soporte para contenedores y despliegues
  
  // Aprovechamiento de Edge Functions
  experimental: {
    runtime: 'edge',
    serverComponents: true,
    concurrentFeatures: true,
  },
  
  // Optimizaci√≥n espec√≠fica de im√°genes para Vercel
  images: {
    domains: ['cdn.tusitio.com', 'images.unsplash.com', 'res.cloudinary.com'],
    formats: ['image/avif', 'image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    // Loader espec√≠fico para Vercel (por defecto)
    loader: 'default',
    // Para usar Cloudflare Images
    // loader: 'custom',
    // loaderFile: './utils/cloudflare-image-loader.js',
  },
  
  // Otras optimizaciones Vercel-espec√≠ficas...
};
```

### Configuraci√≥n para Cloudflare

```javascript
// Loader personalizado para Cloudflare Images (si se usa)
// utils/cloudflare-image-loader.js
export default function cloudflareLoader({ src, width, quality }) {
  const params = [`width=${width}`];
  if (quality) {
    params.push(`quality=${quality}`);
  }
  return `https://imagedelivery.net/tu-account-hash/${src}/${params.join(',')}`;
}

// Headers espec√≠ficos para Cloudflare
const cloudflareHeaders = [
  {
    source: '/:path*',
    headers: [
      {
        key: 'Cache-Control',
        value: 'public, max-age=3600, s-maxage=86400, stale-while-revalidate=31536000',
      },
      // Headers recomendados para Cloudflare
      {
        key: 'CDN-Cache-Control',
        value: 'public, max-age=86400',
      },
      {
        key: 'Cloudflare-CDN-Cache-Control',
        value: 'max-age=86400',
      },
    ],
  },
  // Configuraci√≥n espec√≠fica para recursos est√°ticos
  {
    source: '/static/:path*',
    headers: [
      {
        key: 'Cache-Control',
        value: 'public, max-age=31536000, immutable',
      },
    ],
  },
];
```

### Middlewares para Cloudflare y Vercel

```typescript
// middleware.ts - Para Edge Functions
import { NextResponse, NextRequest } from 'next/server';

export default function middleware(req: NextRequest) {
  const response = NextResponse.next();
  
  // A√±adir headers para optimizaci√≥n de Cloudflare
  response.headers.set('Cache-Control', 'public, max-age=3600, s-maxage=86400');
  response.headers.set('CDN-Cache-Control', 'public, max-age=86400');
  
  // Configuraci√≥n de seguridad
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // Opcional: Detectar y redirigir bots maliciosos
  const userAgent = req.headers.get('user-agent') || '';
  if (userAgent.includes('bad-bot')) {
    return NextResponse.redirect(new URL('/bot-detected', req.url));
  }
  
  return response;
}

export const config = {
  matcher: [
    // Aplicar el middleware a todas las rutas excepto a est√°ticos
    '/((?!_next/static|favicon.ico|robots.txt).*)',
  ],
};
```

---

## üõ†Ô∏è Reglas adicionales para Cloudflare y Vercel

- Utilizar dominios personalizados conectando Vercel con Cloudflare DNS
- Configurar el proxy de Cloudflare para todos los registros DNS (icono naranja)
- Activar HTTPS estricto en Cloudflare (SSL/TLS > Edge Certificates)
- Implementar Cloudflare Workers para l√≥gica espec√≠fica en el edge
- Utilizar Vercel Edge Functions para funcionalidades regionales/geoespec√≠ficas
- Activar Auto Minify en Cloudflare para HTML, CSS y JavaScript
- Habilitar Always Online y Automatic Platform Optimization en Cloudflare
- Configurar Page Rules en Cloudflare para casos espec√≠ficos de cach√©
- Utilizar Workers KV para almacenamiento clave-valor en el edge
- Implementar Zaraz de Cloudflare para gesti√≥n de scripts de terceros 